syntax = "proto3";

package omas.v1;

import "google/api/annotations.proto";
import "google/api/client.proto";
import "google/api/field_behavior.proto";
import "google/api/field_info.proto";
import "google/api/resource.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/field_mask.proto";
//import "google/protobuf/struct.proto";
//import "google/protobuf/wrappers.proto";
import "google/protobuf/timestamp.proto";
import "omas/type/fulfillment.proto";
import "omas/type/order.proto";

option csharp_namespace = "Omas.Protos.V1";

service OmasOrderService {
  //preview order with totals, availability, etc.
  rpc PreviewOrder(PreviewOrderRequest) returns (PreviewOrderResponse) {
    option (google.api.http) = {
      post: "/v1/{parent=vendors/*}:previewOrder"
      body: "*"
    };
    option (google.api.method_signature) = "parent";
  }

  //submit and charge order
  rpc PlaceOrder(PlaceOrderRequest) returns (PlaceOrderResponse) {
    option (google.api.http) = {
      post: "/v1/{parent=vendors/*}:placeOrder"
      body: "*"
    };
    option (google.api.method_signature) = "parent";
  }

  //acknowledge, accept or decline order
  rpc ConfirmOrder(ConfirmOrderRequest) returns (omas.type.Fulfillment) {
    option (google.api.http) = {
      post: "/v1/{name=vendors/*/orders/*}:confirm"
      body: "*"
    };
    option (google.api.method_signature) = "name";
  }

  //advance order process state: sourcing, assembly, picking & packaging
  rpc ProcessOrder(ProcessOrderRequest) returns (omas.type.Fulfillment) {
    option (google.api.http) = {
      post: "/v1/{name=vendors/*/orders/*}:process"
      body: "*"
    };
    option (google.api.method_signature) = "name";
  }

  //advance order delivery state: shipment & delivery
  rpc DeliverOrder(DeliverOrderRequest) returns (omas.type.Fulfillment) {
    option (google.api.http) = {
      post: "/v1/{name=vendors/*/orders/*}:deliver"
      body: "*"
    };
    option (google.api.method_signature) = "name";
  }

  //finalize order state
  rpc CompleteOrder(CompleteOrderRequest) returns (omas.type.Fulfillment) {
    option (google.api.http) = {
      post: "/v1/{name=vendors/*/orders/*}:complete"
      body: "*"
    };
    option (google.api.method_signature) = "name";
  }

  //get modified orders
  rpc PollOrders(PollOrdersRequest) returns (PollOrdersResponse) {
    option (google.api.http) = {get: "/v1/{parent=vendors/*}/orders:poll"};
    option (google.api.method_signature) = "parent";
  }

  //stream modified orders
  rpc MonitorOrders(MonitorOrdersRequest) returns (stream OrderReply) {
    option (google.api.http) = {get: "/v1/{parent=vendors/*}/orders:monitor"};
    option (google.api.method_signature) = "parent";
  }

  /* standard methods */

  //get order (AIP-131)
  rpc GetOrder(GetOrderRequest) returns (omas.type.Fulfillment) {
    option (google.api.http) = {get: "/v1/{name=vendors/*/orders/*}"};
    option (google.api.method_signature) = "name";
  }

  //list orders (AIP-134)
  rpc ListOrders(ListOrdersRequest) returns (ListOrdersResponse) {
    option (google.api.http) = {get: "/v1/{parent=vendors/*}/orders"};
    option (google.api.method_signature) = "parent";
  }

  //update order (AIP-132)
  rpc UpdateOrder(UpdateOrderRequest) returns (omas.type.Fulfillment) {
    option (google.api.http) = {
      patch: "/v1/{fulfillment.name=vendors/*/orders/*}"
      body: "fulfillment"
    };
    option (google.api.method_signature) = "fulfillment,update_mask";
  }
}

message PreviewOrderRequest {
  // Format: vendors/{vendor}
  string parent = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {child_type: "omas.type/Order"}
  ];

  omas.type.Order order = 5;
}

message PreviewOrderResponse {
  // Validated/enriched order with calculated totals, availability, etc.
  omas.type.Order order = 5;

  // Merchant authorization for this specific order preview.
  // Only valid when placeable=true.
  OrderAuthorization authorization = 10;

  // Whether this order can be placed with the current data.
  // When false, the order has calculated values but cannot be used with PlaceOrder.
  bool placeable = 15;

  // Validation issues preventing order placement.
  // Empty when placeable=true.
  repeated ValidationIssue validation_issues = 16;

  // Describes a validation issue that prevents order placement.
  message ValidationIssue {
    // Field path that has the issue (e.g., "delivery.address", "payment.method").
    string field_path = 1;

    // Issue code for programmatic handling.
    ValidationCode code = 2;

    // Human-readable description of the issue.
    string description = 3;

    enum ValidationCode {
      VALIDATION_CODE_UNSPECIFIED = 0;

      // Field is required but missing.
      REQUIRED = 1;

      // Field value is invalid.
      INVALID = 2;

      // Option or product is not available.
      UNAVAILABLE = 3;

      // Minimum order value not met.
      MINIMUM_NOT_MET = 4;
    }
  }
}

message OrderAuthorization {
  // Opaque signed token covering: order_hash + vendor_id + timestamp + terms
  // Server verifies this on placeOrder()
  bytes signature = 1;

  // When this authorization expires (e.g., 15-30 minutes)
  google.protobuf.Timestamp expire_time = 2;

  // Hash of the authorized order state (allows client to detect drift)
  bytes order_hash = 3;
}

message PlaceOrderRequest {
  // Format: vendors/{vendor}
  string parent = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {child_type: "omas.type/Order"}
  ];

  // This request is idempotent if a `request_id` is provided.
  // Fallbacks to order.id
  string request_id = 4 [(google.api.field_info).format = UUID4];

  omas.type.Order order = 5;

  //callback for payment provider
  string status_url = 6;

  // Authorization from PreviewOrderResponse - proves order was previewed
  OrderAuthorization authorization = 10;

  // Webhook URL for order status change notifications (out of band).
  // Uses Standard Webhooks format (https://github.com/standard-webhooks/standard-webhooks):
  // {
  //   "type": "order.status",
  //   "timestamp": "2024-01-15T12:00:00Z",
  //   "data": {
  //     "order": "vendors/{vendor}/orders/{order}",
  //     "state": "Fulfillment.State",
  //     "reason": "optional reason for state change"
  //   }
  // }
  string tracking_url = 11;
}

message PlaceOrderResponse {
  // The name of the order to placed.
  // Format: vendors/{vendor}/orders/{order}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "omas.type/Fulfillment"}
  ];

  omas.type.Order order = 5;
  string pay_url = 6;

  // Opaque secret token for anonymous order access.
  // Store securely - grants access to full order details.
  // Pass via Authorization header: "Bearer <order_secret>"
  // Format: URL-safe base64 encoded string (~43 characters).
  string order_secret = 10;
}

message ConfirmOrderRequest {
  // the name of order to acknowledge
  // Format: vendors/{vendor}/orders/{order}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "omas.type/Fulfillment"}
  ];

  oneof content {
    //none: acknowledge receive
    google.protobuf.Empty acknowledge = 5 [json_name = "ack"];

    //accept order
    Accept accept = 6;

    //decline reason
    string decline = 7;
  }

  message Accept {
    //packaging time estimate
    google.protobuf.Timestamp packaging_time = 5;

    //delivery time estimate
    google.protobuf.Timestamp delivery_time = 6;
  }
}

message ProcessOrderRequest {
  // the name of order to process
  // Format: vendors/{vendor}/orders/{order}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "omas.type/Fulfillment"}
  ];

  oneof content {
    //none: processing
    omas.type.Sourcing sourcing = 6;
    omas.type.Assembly assembly = 7;
    omas.type.Packaging packaging = 8;
  }

  bool completed = 15; //step completed
}

message DeliverOrderRequest {
  // the name of order to acknowledge
  // Format: vendors/{vendor}/orders/{order}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "omas.type/Fulfillment"}
  ];

  oneof content {
    //none
    omas.type.Shipment shipment = 6;
    omas.type.Delivery delivery = 7;
  }

  bool completed = 15; //step completed
}

message CompleteOrderRequest {
  // the name of order to acknowledge
  // Format: vendors/{vendor}/orders/{order}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "omas.type/Fulfillment"}
  ];

  oneof content {
    //none: completing
    omas.type.Settlement settlement = 6;

    string cancel = 11; //cancelation reason
  }
}

message GetOrderRequest {
  // The name of the order to retrieve.
  // Format: vendors/{vendor}/orders/{order}
  string name = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {type: "omas.type/Fulfillment"}
  ];

  // see: https://google.aip.dev/157
  // View resolution:
  // 1. Authenticated vendor request: FULL (default)
  // 2. Valid order_secret in Authorization header: FULL (default)
  // 3. Unauthenticated without secret: BASIC only
  // 4. Invalid order_secret: PERMISSION_DENIED error
  OrderView view = 8;
}

message ListOrdersRequest {
  // The parent, which owns this collection of orders.
  // Format: vendors/{vendor}
  string parent = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {child_type: "omas.type/Fulfillment"}
  ];

  int32 page_size = 2; // Default 50, Maximum 1000;
  string page_token = 3;

  //see: https://google.aip.dev/157
  //default: BASIC
  OrderView view = 8;

  // Filter expression for AIP-160 filtering
  // Supported fields: vendor_id, state, create_time
  // Examples:
  //   state = "COMPLETED"
  //   create_time >= "2024-01-01T00:00:00Z"
  //   vendor_id = "vendor123" AND state = "PENDING"
  // see: https://google.aip.dev/160
  string filter = 6;

  // Order by expression for AIP-132 ordering
  // Supported fields: create_time, update_time
  // Default: create_time desc
  // Examples: create_time desc, create_time asc
  // see: https://google.aip.dev/132#ordering
  string order_by = 7;

  //todo show_deleted https://google.aip.dev/132#soft-deleted-resources
}

message ListOrdersResponse {
  repeated omas.type.Fulfillment fulfillments = 1;

  //maybe int32 total_size = 2;
  string next_page_token = 3;

  //unreachable https://google.aip.dev/217
  repeated string unreachable = 4 [(google.api.field_behavior) = UNORDERED_LIST];
}

enum OrderView {
  ORDER_VIEW_UNSPECIFIED = 0;

  //ussage: anaonymous order tracking
  ORDER_VIEW_BASIC = 1;

  //all available fields
  ORDER_VIEW_FULL = 15;
}

message UpdateOrderRequest {
  // The order to update.
  //
  // The fulfillment's `name` field is used to identify the order to be updated.
  // Format: vendors/{vendor}/orders/{order}
  omas.type.Fulfillment fulfillment = 1 [(google.api.field_behavior) = REQUIRED];

  // The list of fields to be updated. (repeated fields are replaced)
  google.protobuf.FieldMask update_mask = 2;
}

message PollOrdersRequest {
  //The parent, which owns the orders.
  //Format: vendors/{vendor}
  string parent = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {child_type: "omas.type/Fulfillment"}
  ];

  //The page size
  //Default: 50
  //Maximum: 1000
  int32 page_size = 2;
  string page_token = 3;

  //long poll timeout
  //Default: 30s
  google.protobuf.Duration timeout = 4;

  google.protobuf.Timestamp start_time = 7;

  //todo string filter see: https://google.aip.dev/160
  //todo show_deleted https://google.aip.dev/132#soft-deleted-resources
}

message PollOrdersResponse {
  repeated omas.type.Fulfillment fulfillments = 1;

  //maybe int32 pending_count = 2;
  string next_page_token = 3;
}

message MonitorOrdersRequest {
  //The parent, which owns the orders.
  //Format: vendors/{vendor}
  string parent = 1 [
    (google.api.field_behavior) = REQUIRED,
    (google.api.resource_reference) = {child_type: "omas.type/Fulfillment"}
  ];

  uint64 start_sequence = 2 [json_name = "startSeq"];
  google.protobuf.Timestamp start_time = 3;

  //pulse interval
  //Default: 50s
  google.protobuf.Duration keep_alive = 7;

  //todo filters;
  //todo mode last, new, limit
  //todo views
}

message OrderReply {
  uint64 sequence = 1 [json_name = "seq"];
  google.protobuf.Timestamp timestamp = 2 [json_name = "ts"];

  omas.type.Fulfillment fulfillment = 5;
}
